# Kids Can Deployment Guide

## Prerequisites

1. **Accounts needed:**
   - [Render.com](https://render.com) account
   - [Stripe](https://stripe.com) account (production keys)
   - [AWS](https://aws.amazon.com) account (for S3)
   - [Resend](https://resend.com) account (for emails)
   - Domain name (e.g., joinkidscan.com)

## Step 1: Environment Variables Preparation

### Backend Environment Variables

Create these environment variables in Render dashboard:

```bash
# Database (auto-generated by Render)
DATABASE_URL=<auto-generated>

# JWT Secrets (use Render's "Generate" button)
JWT_SECRET=<generate-random-64-char-string>
JWT_EXPIRES_IN=1h
JWT_REFRESH_SECRET=<generate-random-64-char-string>
JWT_REFRESH_EXPIRES_IN=7d

# API Configuration
NODE_ENV=production
PORT=8080
API_PREFIX=api/v1

# Frontend URL (update after deploying frontend)
FRONTEND_URL=https://joinkidscan.com

# Email Configuration (Resend)
RESEND_API_KEY=re_your_production_key
EMAIL_FROM=hello@joinkidscan.com

# Stripe Configuration (use production keys)
STRIPE_SECRET_KEY=sk_live_your_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# AWS S3 Configuration
AWS_S3_REGION=us-east-1
AWS_S3_BUCKET=kidscan-uploads-prod
AWS_ACCESS_KEY_ID=your_aws_key
AWS_SECRET_ACCESS_KEY=your_aws_secret

# File Upload Configuration
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=image/jpeg,image/jpg,image/png,image/webp
```

### Frontend Environment Variables

Create `.env.production` file:

```bash
VITE_API_URL=https://kidscan-api.onrender.com/api/v1
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_your_key
```

## Step 2: Database Setup

1. **Render will automatically create the database** when you deploy using render.yaml

2. **Run migrations after first deployment:**
   ```bash
   # SSH into your Render service or run via Render Shell
   npm run migrate
   ```

## Step 3: Deploy Backend to Render

1. **Push your code to GitHub:**
   ```bash
   git add .
   git commit -m "Prepare for production deployment"
   git push origin main
   ```

2. **Connect to Render:**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +"
   - Select "Blueprint"
   - Connect your GitHub repo
   - Select the branch (main)
   - Render will detect your `render.yaml`

3. **Configure environment variables:**
   - Go to your service settings
   - Add all the environment variables listed above
   - Save changes

4. **Deploy:**
   - Click "Manual Deploy" or it will auto-deploy on git push

## Step 4: Deploy Frontend

### Option A: Deploy to Vercel (Recommended)

1. **Build the frontend:**
   ```bash
   cd kidscan-web-app
   npm run build
   ```

2. **Install Vercel CLI:**
   ```bash
   npm i -g vercel
   ```

3. **Deploy:**
   ```bash
   vercel --prod
   ```

4. **Set environment variables in Vercel:**
   - Go to your Vercel dashboard
   - Project Settings → Environment Variables
   - Add the production env vars

### Option B: Deploy to Netlify

1. **Build command:** `npm run build`
2. **Publish directory:** `dist`
3. **Add environment variables in Netlify dashboard**

## Step 5: Configure Stripe Webhooks

1. **Go to Stripe Dashboard → Webhooks**
2. **Add endpoint:**
   - URL: `https://kidscan-api.onrender.com/api/v1/billing/webhook`
   - Events to listen for:
     - `checkout.session.completed`
     - `customer.subscription.created`
     - `customer.subscription.updated`
     - `customer.subscription.deleted`
     - `invoice.payment_succeeded`
     - `invoice.payment_failed`

3. **Copy the webhook secret** and update `STRIPE_WEBHOOK_SECRET` in Render

## Step 6: Configure Custom Domain

### For Frontend (Vercel/Netlify):
1. Add your domain in the platform's settings
2. Update DNS records as instructed

### For Backend API (Optional):
1. Add custom domain in Render
2. Create CNAME record: `api.joinkidscan.com` → `kidscan-api.onrender.com`

## Step 7: Post-Deployment Checklist

- [ ] Test user registration with magic links
- [ ] Test email delivery (check Resend dashboard)
- [ ] Test Stripe payment setup flow
- [ ] Test image uploads to S3
- [ ] Verify CORS settings allow your frontend domain
- [ ] Test teen-homeowner connection flow
- [ ] Monitor Render logs for any errors
- [ ] Set up monitoring (e.g., UptimeRobot)

## Step 8: Production Database Backup

Set up automated backups in Render:
1. Go to Database settings
2. Enable "Daily Backups"
3. Set retention period (recommended: 7 days)

## Monitoring and Logs

- **Backend logs:** Render Dashboard → Services → kidscan-api → Logs
- **Database metrics:** Render Dashboard → Databases → kidscan-db
- **Email logs:** Resend Dashboard
- **Payment logs:** Stripe Dashboard
- **Error tracking:** Consider adding Sentry for production

## Scaling Considerations

When you need to scale:
1. **Upgrade Render plan** for more resources
2. **Enable auto-scaling** in Render settings
3. **Consider CDN** for static assets (Cloudflare)
4. **Database pooling** is already configured

## Security Checklist

- [ ] All secrets are in environment variables
- [ ] HTTPS is enforced (automatic with Render)
- [ ] CORS is configured for your domain only
- [ ] Rate limiting is enabled
- [ ] Database connections use SSL
- [ ] S3 bucket has proper access policies

## Troubleshooting

### Common Issues:

1. **"Cannot connect to database"**
   - Check DATABASE_URL is set correctly
   - Ensure migrations have run

2. **"Stripe webhook failing"**
   - Verify webhook secret matches
   - Check endpoint URL is correct
   - Ensure webhook endpoint is public

3. **"Emails not sending"**
   - Verify Resend API key
   - Check EMAIL_FROM domain is verified

4. **"CORS errors"**
   - Update FRONTEND_URL in backend env vars
   - Clear browser cache

## Support

For deployment help:
- Render: [docs.render.com](https://docs.render.com)
- Stripe: [stripe.com/docs](https://stripe.com/docs)
- Resend: [resend.com/docs](https://resend.com/docs)